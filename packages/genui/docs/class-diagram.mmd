classDiagram
    namespace Facade {
        class GenUiConversation {
            +GenUiController controller
            +GenUiTransport transport
            +ValueListenable~ConversationState~ state
            +Stream~ConversationEvent~ events
            +Future~void~ sendRequest(ChatMessage message)
            +void dispose()
        }
    }

    namespace Interfaces {
        class GenUiTransport {
            <<interface>>
            +Stream~A2uiMessage~ incomingMessages
            +Stream~String~ incomingText
            +Future~void~ sendRequest(ChatMessage message)
        }

        class GenUiHost {
            <<interface>>
            +Stream~GenUiUpdate~ surfaceUpdates
            +GenUiContext contextFor(String surfaceId)
        }

        class GenUiContext {
            <<interface>>
            +String surfaceId
            +ValueListenable~UiDefinition?~ definition
            +DataModel dataModel
            +Iterable~Catalog~ catalogs
            +void handleUiEvent(UiEvent event)
        }

        class A2uiMessageSink {
            <<interface>>
            +void handleMessage(A2uiMessage message)
        }
    }

    namespace Transport {
        class A2uiTransportAdapter {
            +void addChunk(String text)
            +void addMessage(A2uiMessage message)
            +Stream~A2uiMessage~ incomingMessages
            +Stream~String~ incomingText
            +Future~void~ sendRequest(ChatMessage message)
            +void dispose()
        }
    }

    namespace Engine {
        class GenUiController {
            +void handleMessage(A2uiMessage message)
            +Stream~GenUiUpdate~ surfaceUpdates
            +Stream~ChatMessage~ onSubmit
            +Map~String, DataModel~ dataModels
            +Iterable~String~ activeSurfaceIds
            +GenUiContext contextFor(String surfaceId)
            +ValueListenable~UiDefinition?~ watchSurface(String surfaceId)
            +void dispose()
        }
    }

    namespace UI {
        class GenUiSurface {
            +GenUiContext context
            +WidgetBuilder? defaultBuilder
        }
    }

    namespace Model {
        class Catalog {
            +String? catalogId
            +Iterable~CatalogItem~ items
            +Schema definition
            +Widget buildWidget(CatalogItemContext context)
            +Catalog copyWith(List~CatalogItem~ newItems)
            +Catalog copyWithout(Iterable~CatalogItem~ itemNames)
        }

        class CatalogItem {
            +String name
            +Schema dataSchema
            +CatalogWidgetBuilder widgetBuilder
            +List~ExampleBuilderCallback~ exampleData
        }

        class DataModel {
            +void update(DataPath? path, Object? contents)
            +ValueNotifier subscribe(DataPath path)
            +ValueNotifier subscribeToValue(DataPath path)
            +T? getValue(DataPath path)
            +void bindExternalState(DataPath path, ValueListenable source)
            +void dispose()
        }
    }

    GenUiHost <|.. GenUiController
    A2uiMessageSink <|.. GenUiController
    GenUiTransport <|.. A2uiTransportAdapter
    GenUiSurface --> GenUiContext : uses
    GenUiHost --> GenUiContext : creates
    Catalog --> CatalogItem : contains
    GenUiContext --> DataModel : manages
    GenUiConversation --> GenUiController : uses
    GenUiConversation --> GenUiTransport : uses
    GenUiController --> Catalog : uses