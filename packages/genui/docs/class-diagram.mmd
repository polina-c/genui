classDiagram
    namespace Facade {
        class GenUiConversation {
            +GenUiController controller
            +GenUiHost host
            +ValueListenable~List~ChatMessage~~ conversation
            +ValueListenable~bool~ isProcessing
            +Future~void~ sendRequest(ChatMessage message)
            +void dispose()
        }
    }

    namespace Transport {
        class GenUiController {
            +void addChunk(String text)
            +void addMessage(A2uiMessage message)
            +Stream~String~ textStream
            +Stream~A2uiMessage~ messageStream
            +void dispose()
        }
    }

    namespace Core {
    class GenUiHost {
            <<interface>>
            +Stream~GenUiUpdate~ surfaceUpdates
            +GenUiContext contextFor(String surfaceId)
        }

        class GenUiContext {
            <<interface>>
            +String surfaceId
            +ValueListenable~UiDefinition?~ definition
            +DataModel dataModel
            +Iterable~Catalog~ catalogs
            +void handleUiEvent(UiEvent event)
        }

        class A2uiMessageSink {
            <<interface>>
            +void handleMessage(A2uiMessage message)
        }

        class A2uiMessageProcessor {
            +void handleMessage(A2uiMessage message)
            +Stream~GenUiUpdate~ surfaceUpdates
            +Stream~ChatMessage~ onSubmit
            +Map~String, DataModel~ dataModels
            +DataModel dataModelForSurface(String surfaceId)
            +Map~String, Object?~ getClientDataModel()
            +ValueNotifier~UiDefinition?~ getSurfaceNotifier(String surfaceId)
            +void dispose()
        }
    }

    namespace UI {
        class GenUiSurface {
            +GenUiContext context
            // +String surfaceId (implied by context)
            +WidgetBuilder? defaultBuilder
        }
    }

    namespace Model {
        class Catalog {
            +String? catalogId
            +Iterable~CatalogItem~ items
            +Schema definition
            +Widget buildWidget(CatalogItemContext context)
            +Catalog copyWith(List~CatalogItem~ newItems)
            +Catalog copyWithout(Iterable~CatalogItem~ itemNames)
        }

        class CatalogItem {
            +String name
            +Schema dataSchema
            +CatalogWidgetBuilder widgetBuilder
            +List~ExampleBuilderCallback~ exampleData
        }

        class DataModel {
            +void update(DataPath? path, Object? contents)
            +ValueNotifier subscribe(DataPath path)
            +ValueNotifier subscribeToValue(DataPath path)
            +T? getValue(DataPath path)
            +void bindExternalState(DataPath path, ValueListenable source)
            +void dispose()
        }
    }

    GenUiHost <|.. A2uiMessageProcessor
    A2uiMessageSink <|.. A2uiMessageProcessor
    GenUiSurface --> GenUiContext : uses
    GenUiHost --> GenUiContext : creates
    Catalog --> CatalogItem : contains
    GenUiContext --> DataModel : manages
    GenUiConversation --> GenUiController : uses
    GenUiConversation --> GenUiHost : uses
    GenUiConversation --> A2uiMessageSink : converts messages to
    A2uiMessageProcessor --> Catalog : uses