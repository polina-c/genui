graph TD
    subgraph "genui Package"
        Conversation["Conversation (Facade)"]
        Transport["Transport (Interface)"]
        A2uiTransportAdapter["A2uiTransportAdapter"]
        SurfaceController["SurfaceController (Engine)"]
        Transformer["A2uiParserTransformer"]
        Catalog["Widget Catalog"]
        DataModel["DataModel"]
        Surface["Surface (Widget)"]
    end


    AppLogic -- "Initializes" --> Conversation
    Conversation -- "Uses" --> Transport
    Conversation -- "Manages" --> SurfaceController

    AppLogic -- "Sends User Input" --> Conversation
    Conversation -- "Delegates to" --> Transport
    Transport -- "Calls callback" --> ExternalLLM
    ExternalLLM -- "Returns chunks" --> A2uiTransportAdapter
    A2uiTransportAdapter -- "Pipes to" --> Transformer
    Transformer -- "Parses into<br>messages" --> A2uiTransportAdapter
    A2uiTransportAdapter -- "Stream<A2uiMessage>" --> Transport
    Transport -- "Pipes to" --> Conversation
    Conversation -- "Dispatches to" --> SurfaceController

    SurfaceController -- "Owns" --> DataModel
    SurfaceController -- "Notifies of updates" --> Conversation
    SurfaceController -- "Notifies of updates" --> Surface

    UserUI -- "Instantiates" --> Surface
    Surface -- "Builds widgets using" --> Catalog
    Surface -- "Reads/writes state via" --> DataModel
    Surface -- "Sends UI events" --> SurfaceController

    SurfaceController -- "Client events (onSubmit)" --> Conversation
    Conversation -- "Loops back" --> Transport