graph TD
    subgraph "Developer's Application"
        AppLogic["App Logic"]
        UIWidgets["UI Widgets<br>(e.g., GenUiSurface)"]
        ExternalLLM["External LLM Client"]
    end

    subgraph "genui Package"
        GenUiConversation["GenUiConversation (Facade)"]
        GenUiController["GenUiController"]
        Transformer["A2uiParserTransformer"]
        A2uiMessageProcessor["A2uiMessageProcessor"]
        Catalog["Widget Catalog"]
        DataModel["DataModel"]
    end

    AppLogic -- "Initializes" --> GenUiConversation
    GenUiConversation -- "Wraps" --> GenUiController
    GenUiController -- "Owns" --> A2uiMessageProcessor
    GenUiController -- "Uses" --> Transformer

    A2uiMessageProcessor -- "Owns" --> DataModel

    AppLogic -- "Sends User Input" --> GenUiConversation
    GenUiConversation -- "Calls callback" --> ExternalLLM
    ExternalLLM -- "Returns chunks" --> GenUiController
    GenUiController -- "Pipes to" --> Transformer
    Transformer -- "Parses into events" --> A2uiMessageProcessor

    A2uiMessageProcessor -- "Notifies of updates" --> UIWidgets
    UIWidgets -- "Builds widgets using" --> Catalog
    UIWidgets -- "Reads/writes state via" --> DataModel
    UIWidgets -- "Sends UI events to" --> A2uiMessageProcessor

    A2uiMessageProcessor -- "Client events" --> GenUiController
    GenUiController -- "Forwards events" --> GenUiConversation
    GenUiConversation -- "Loops back" --> ExternalLLM